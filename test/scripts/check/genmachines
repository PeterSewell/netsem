#! /bin/bash

# ---------------------------------------------------------------------
# User configurable:
# ~~~~~~~~~~~~~~~~~~
# OUTPUT - file name for the auto-generated output file
# MINMEMORY - minimum memory in KB that a machine must have to be
#             selected
# MINMHZ - minimum CPU speed that a machine must have to be selected
#
# INUSE_MPHIL_SCRIPT - script to use to determine if an mphil machine
#                      is "in use"
# INUSE_MPHIL_MACH - mphil machine to use use INUSE_MPHIL_SCRIPT on
#
# INUSE_SCRIPT - script to use to determine if a lab (non-mphil)
#                 machine is "in use"
# INUSE_CONF_DIR - configuration directory that lists lab machines and
#                  individual usage policies
#
# MACHINES - any extra machine to "just use" (should normally be
#            empty)
# AVOID_MACHINES - machines that are NOT to be used at all cost
# ---------------------------------------------------------------------

OUTPUT=./machines.conf
MINMEMORY=255000
MINMHZ=600

INUSE_MPHIL_SCRIPT=/homes/pb/pl/inuse.pl
INUSE_MPHIL_MACH="`hosts mphil`"

INUSE_SCRIPT=/usr/groups/tthee/local/Net/TCP/Test/scripts/check/inuse2.pl
INUSE_CONF_DIR=/usr/groups/tthee/conf

MACHINES=""
AVOID_MACHINES=""

# ----------------------------------------------------------------------

cd $INUSE_CONF_DIR
for f in *; do
  if /usr/bin/ssh $f "echo -n" >/dev/null; then
    MACHINES="${MACHINES} $f"
  fi
done
cd -

ALL_MACHINES="`echo $MACHINES $INUSE_MPHIL_MACH | sed "s/[\t' ']*//"`"
PTC_MACHINES=""

echo "# ------------------------------------------------------------" > $OUTPUT
echo "# This file is auto-generated by genmachines. DO NOT EDIT!!!" >> $OUTPUT
echo "# ------------------------------------------------------------" >> $OUTPUT
echo "# Scanned machines:" >> $OUTPUT

for mach in $ALL_MACHINES; do
    echo "Checking $mach..."
    # Skip over the machines we are not allowed to utilize
    SKIP=0
    for barred in $AVOID_MACHINES; do
	if [ $barred == $mach ]; then SKIP=1; fi
    done

    # If mphil then use INUSE_MPHIL_SCRIPT otherwise don't
    INUSE_MPHIL=0
    for m in $INUSE_MPHIL_MACH; do
	if [ $m == $mach ]; then INUSE_MPHIL=1; fi
    done

    # If we can utilize a machine probe it and decide whether we will use it or not
    if [ $SKIP -eq 0 ]; then

	NUMPROC="`ssh $mach 'cat /proc/cpuinfo | grep "^processor" | wc -l | sed "s/[\t' '\n]*//"'`"
	MHZ=`ssh $mach 'cat /proc/cpuinfo | grep "cpu MHz" | head -n 1 | sed -e "s/cpu MHz//" | tr -d [:blank:] | tr -d : | sed -e "s/['.'][0-9]*//"'`
	MEMTOTAL=`ssh $mach 'cat /proc/meminfo | grep "MemTotal:" | head -n 1 | sed "s/MemTotal:[\t' ']*\([0-9]*\)[\t' ']*kB/\1/"'`

	if (($MHZ > $MINMHZ)) && (($MEMTOTAL > $MINMEMORY));  then
	    PTC_MACHINES="$PTC_MACHINES -j${mach}:$NUMPROC";
	    if [ $INUSE_MPHIL -eq 1 ]; then
		PTC_MACHINES="$PTC_MACHINES=$INUSE_MPHIL_SCRIPT"
            else
		PTC_MACHINES="$PTC_MACHINES=$INUSE_SCRIPT"
	    fi
		echo "#   $mach: $NUMPROC cpus, ${MHZ}Mhz, ${MEMTOTAL}KB memory" >> $OUTPUT
	else
	    echo "#   $mach: $NUMPROC cpus, ${MHZ}Mhz, ${MEMTOTAL}KB memory (NOT SELECTED)" >> $OUTPUT
	fi

    else

	#If we are forbidden to use a machine mark it as DO NOT USE.
	echo "#   $mach: $NUMPROC cpus, ${MHZ}Mhz, ${MEMTOTAL}KB memory (DO NOT USE)" >> $OUTPUT

    fi

done

echo "" >> $OUTPUT
echo "# ------------------------------------------------------------" >> $OUTPUT
echo "# Set the machines to be used" >> $OUTPUT
echo "# NB: machines with less that ${MINMEMORY}KB total memory or with" >> $OUTPUT
echo "#     processors slower than ${MINMHZ}MHz have not been selected." >> $OUTPUT
echo "# ------------------------------------------------------------" >> $OUTPUT
echo "" >> $OUTPUT
echo "PTCMACHINES=\"$PTC_MACHINES\"" >> $OUTPUT
echo "" >> $OUTPUT
echo "# ------------------------------------------------------------" >> $OUTPUT
echo "# END OF AUTOGENERATED FILE" >> $OUTPUT
echo "# ------------------------------------------------------------" >> $OUTPUT
